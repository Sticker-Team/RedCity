<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Red City</title>
		<link rel="stylesheet" type="text/css" href="Styles/style.css">
		<script type="text/javascript" src="cordova.js"></script>
	</head>

	<body>
		<div id = "gamearea">
			<canvas id = "mcanvas" style = "z-index: 1">
				Your browser does not support the HTML5 'Canvas' tag.
			</canvas>

		</div>
	</body>
</html>

<script src = "./Objects/objects.js"></script>
<script>
/**
*	Canvas and context
**/

// Foreground Canvas
var maincanvas;
var mctx;

/**
*	Game State Variables
**/
	
var sprites;
var go;
var windowWidth;
var windowHeight;
	
/**
*	Intervals
**/

var renderCanvasInterval = null;
	
/**
*	Images
**/

var building_1 = new Image();
building_1.src = "./Images/Sprites/building_new_1.png";

/**
*	Sound
**/

// Start
window.onload = onAllAssetsLoaded;
onDeviceReady();

// On load
function onAllAssetsLoaded(){
	//document.addEventListener("deviceready", onDeviceReady, false);
	onDeviceReady(); // This is for web testing
}

function onDeviceReady(){
    maincanvas = document.getElementById("mcanvas");
    mctx = maincanvas.getContext("2d");
	
	/*
	maincanvas.addEventListener("touchstart", handleTouchstartEvent, false);
	maincanvas.addEventListener("touchend", handleTouchendEvent, false);
    maincanvas.addEventListener("touchmove", handleTouchmoveEvent, false);
		*/
		
	gameSetup();
}

function gameSetup(){
	resizeWindow();
	initialise();
	generateWorld();
	roundSetup();
	
}

function generateWorld(){
	go = new GameObject(building_1, 0, 0, 100, 100);
	sprites.push(go);
}

function resizeWindow(){
	var gameArea = document.getElementById('gamearea');
	var widthToHeight = 2 / 1;
	var newWidth = window.innerWidth;
	var newHeight = window.innerHeight;
	var newWidthToHeight = newWidth / newHeight;
	
	if (newWidthToHeight > widthToHeight) {
		// window width is too wide relative to desired game width
		newWidth = newHeight * widthToHeight;
		gameArea.style.height = newHeight + 'px';
		gameArea.style.width = newWidth + 'px';
	} 
	else { 
		//window height is too high relative to desired game height
		newHeight = newWidth / widthToHeight;
		gameArea.style.width = newWidth + 'px';
		gameArea.style.height = newHeight + 'px';
	}
	gameArea.style.marginTop = (-newHeight / 2) + 'px';
	gameArea.style.marginLeft = (-newWidth / 2) + 'px';
	
    maincanvas.width = newWidth;
    maincanvas.height = newHeight;
	
	//Background.prototype.canvasWidth = newWidth;
	//Background.prototype.canvasHeight = newHeight;
	
	//Foreground.prototype.canvasWidth = newWidth;
	//Foreground.prototype.canvasHeight = newHeight;
}

function roundSetup(){

	renderCanvasInterval = setInterval(update, 10);  			// game loop

}

/*
function spawnPlayer(){
	player = new Player();
	characters.push(player);
}



function renderForeground(){
	// Draws all characters on foreground canvas
	fctx.clearRect(0, 0, forecanvas.width, forecanvas.height);
	for(i = 0; i < characters.length; i++){
		characters[i].draw();
	}
}
*/
/*
function createBackground(){
	bg = new Background();
	bg.init(0, 0, maincanvas.width, maincanvas.height);
}
*/

function renderBackground(){
	// Draws all characters on foreground canvas
	mctx.clearRect(0, 0, maincanvas.width, maincanvas.height);
	sprites[0].draw();
	
	//for(i = 0; i < sprites.length; i++){
		//sprites[0].draw();
	//}
	//bg.draw();
}

/*
function renderGUI(){
	// Draws all characters on foreground canvas
	gctx.clearRect(0, 0, guicanvas.width, guicanvas.height);
	gctx.font="30px Trebuchet MS";
	//gctx.fillText("20123", 10, 50);
	gctx.drawImage(swordIcon, forecanvas.width-swordIcon.width-10, (forecanvas.height/2)-(swordIcon.height/2));
	gctx.drawImage(shieldIcon, 10, (forecanvas.height/2)-(shieldIcon.height/2));
	//gui.draw();
}
*/

/*
function drawRetry(){
	gctx.drawImage(retryMenu, (gcanvas.width/2)-retryMenu.width/2, (gcanvas.height/2)-retryMenu.height/2);
	gctx.fillText(kills, gcanvas.width/2-50, gcanvas.height/2-20);
}
*/

/*
function drawWin(){
	gctx.drawImage(victoryMenu, (gcanvas.width/2)-victoryMenu.width/2, (gcanvas.height/2)-victoryMenu.height/2);
	gctx.fillText(kills, gcanvas.width/2-50, gcanvas.height/2-20);
}
*/

function update(){
	// Checks whether its necessary to spawn more enemies
	
	//bg.update();
	renderBackground();
	/*
	checkSpawn();
	
	
	if(!dead){
		// Updates background
		if(scroll){
			bg.update();
			fg.update();
		}
		
		// Updates enemies
		if(characters.length > 1){
			characters[1].update();
		}
	}
	else{
		cleanCharacters();
		drawRetry();
	}
	if(kills >= winKills){
		cleanCharacters();
		drawWin();
	}

	if(!scroll){
		characters[1].attack();
	}
	// Render
	renderForeground();
	renderBackground();
	
	// Collision
	collisionTest();
	*/
}

/**
*	Game restart/cleanup
**/
// Used to cleanup/initialise/reinitialise values and start game
function initialise(){
	/*
	characters = [];
	player = null;
	touchStartX = null;
	touchStartY = null;
	screenWasSwiped = false;
	screenDown = false;
	scroll = false;
	collideDistance = 100;
	playerBaseDmg = 50;		// Base damage
	inAir = false;			// Is the player in the air?
	blocking = false;		// Is the player blocking?
	kills = 0;
	score = 0;
	dead = false;
	playerJumpInterval = null;
	jumpCooldownInterval = null;
	playerAttackInterval = null;
	attackCooldownInterval = null;
	enemyAttackCooldownInterval = null;
	spriteChangeInterval = null;
	renderCanvasInterval = null;
	*/
	// Begins new game after cleanup
	gameSetup();
}

function restartGame(){
	spriteChangeInterval = destroyInterval(spriteChangeInterval);
	renderCanvasInterval = destroyInterval(renderCanvasInterval);
	initialise();
}

/*
function cleanCharacters(){
	for(i = 0; i < characters.length; i++){
		characters[i].destroy();
	}
}
*/

/**
*	Hardware functions
**/

function vibrate(){
	navigator.notification.vibrate(200);  // .2 second
}

/*
gameLoop.addEventListener('ended', function() {
this.currentTime = 0;
this.play();
}, false);
*/

function playMusic(){
	if(!musicPlaying){
		gameLoop.play();
		musicPlaying = true;
	}
}

function playSound(sound){
	sound.play();
}

/**
*	Touch functions 
**/

// TESTING PURPOSES KEYBOARD FUNCTIONALITY
document.onkeypress = function (e) {
    e = e || window.event;
    if(e.keyCode == 32){
		player.jump();
	}
	if(e.keyCode == 119){
		player.attack();
	}
};
/*
function handleTouchstartEvent(e){
    touchStartX = e.changedTouches[0].pageX;
    touchStartY = e.changedTouches[0].pageY;
	
	screenDown = true;
	checkTap(touchStartX, touchStartY);
}

function handleTouchmoveEvent(e){
    screenWasSwiped = true;
}

function handleTouchendEvent(e){
    var touchEndX;
    var touchEndY;

	screenDown = false;
    touchEndX = e.changedTouches[0].pageX;
    touchEndY = e.changedTouches[0].pageY;
	
    if(screenWasSwiped){
        screenWasSwiped = false;
		if(Math.abs(touchStartX - touchEndX) > Math.abs(touchStartY - touchEndY)){ // vertical swipe
		
		}
		else{
			if(touchStartY > touchEndY){ // swipe up and jump
				if(jumpCooldownInterval == null){
					player.jump();
				}
			}
		}
    }
	else{	// tap
		checkTap(touchEndX, touchEndY);
	}
}
	
/**
*	Collision functions 
**/
/*
function collisionTest(){
	if(characters.length > 1){
		if(player.getX()+collideDistance > characters[1].getX()){
			scroll = false;
		}
	}
}

function checkTap(x,y){
	if(kills >= winKills){
		if(x > (gcanvas.width/2-80) && x < (gcanvas.width/2+80)){
			if(y > (gcanvas.height/2+90) && y < (gcanvas.height/2+150)){
				restartGame();
			}
		}
	}
	if(!dead){
		// gctx.drawImage(swordIcon, forecanvas.width-swordIcon.width-10, (forecanvas.height/2)-(swordIcon.height/2));
		if(x > (guicanvas.width-swordIcon.width) && x < (guicanvas.width)){
			if(y > (forecanvas.height/2)-(swordIcon.height/2) && y < ((forecanvas.height/2)+(swordIcon.height/2))){
				player.attack();
			}
		}
		
		// gctx.drawImage(shieldIcon, 10, (forecanvas.height/2)-(shieldIcon.height/2));
		if(x > (10) && x < (shieldIcon.width+10)){
			if(y > (forecanvas.height/2)-(shieldIcon.height/2) && y < ((forecanvas.height/2)+(shieldIcon.height/2))){
				player.shield();
			}
		}
	}
	else{
		if(x > (gcanvas.width/2-80) && x < (gcanvas.width/2+80)){
			if(y > (gcanvas.height/2+90) && y < (gcanvas.height/2+150)){
				restartGame();
			}
		}
	}
}
*/

/**
*	Sprite updating
**/

/*

function updateSprites(){
	if(inAir){
		player.jumpAnim();
	}
	else{
		if(scroll){
			player.update();
		}
		else{
			if(blocking){
				
			}
			else{
				player.stillAnim();
			}
		}
	}
	if(screenDown == false){
		characters[0].unblock();
	}
}

/**
*	Game world generation
**/

/*

function checkSpawn(){
	if(scroll && kills < winKills){
		if(characters.length <= 3){
			createNewEnemy();
		}
	}
}

function createNewEnemy(){
	if(kills < 5){
		createGoblin(1000);
	}
	else if(kills < 10){
		createGoblin(1000);
	}
	else{
		createGoblin(1000);
	}
}

function generateWorld(){
	generateMobs();
}

function generateMobs(){
	createGoblin(800);
	createGoblin(1000);
	createGoblin(1200);
	//goblin.setX(goblin.getX()+100);
	//characters.push(goblin);
}
*/
</script>