<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<title>Red City</title>
		<link rel="stylesheet" type="text/css" href="Styles/style.css">
		<script type="text/javascript" charset="utf-8" src="cordova.js"></script>
	</head>

	<body>
		<div id = "gamearea">
			<canvas id = "mcanvas" style = "z-index: 1">
				Your browser does not support the HTML5 'Canvas' tag.
			</canvas>

		</div>
	</body>
</html>

<script src = "./Objects/objects.js"></script>
<script>
/**
*	Canvas and context
**/

// Foreground Canvas
var maincanvas;
var mctx;

/**
*	Game State Variables
**/
	
var sprites;
var backgrounds;
var go;
var screenWidth;
var screenHeight;

var screenDown;
var screenWasSwiped;

var touchStartX;
var touchStartY;
var touchEndX;
var touchEndY;
	
/**
*	Objects
**/
var gameBackground;
var gameBuilding_A;
var gameBuilding_B;
var gameBuilding_C;
var gameBuilding_D;
var gameBuilding_bank;
	
	
/**
*	Intervals
**/

var renderCanvasInterval;
	
/**
*	Images
**/

var building_1 = new Image();
var building_2 = new Image();
var building_3 = new Image();
var building_4 = new Image();
var building_bank = new Image();

var background = new Image();

/**
*	Sound
**/

// Start
window.onload = onAllAssetsLoaded;

// On load

function onAllAssetsLoaded(){
	document.addEventListener("deviceready", onDeviceReady, false);
	onDeviceReady(); // This is for web testing
}

function onDeviceReady(){
    maincanvas = document.getElementById("mcanvas");
    mctx = maincanvas.getContext("2d");
	
	maincanvas.addEventListener("touchstart", handleTouchstartEvent, false);
	maincanvas.addEventListener("touchend", handleTouchendEvent, false);
    maincanvas.addEventListener("touchmove", handleTouchmoveEvent, false);
	
	gameSetup();
}

function gameSetup(){
	initialise();
	resizeWindow();
	generateWorld();
	roundSetup();
}

function initialise(){
	renderCanvasInterval = null;
	sprites = [];
	backgrounds = [];
	touchStartX = [];
	touchStartY = [];
	touchEndX = [];
	touchEndY = [];

	building_1.src = "./Images/Sprites/building_new_1.png";
	building_2.src = "./Images/Sprites/building_new_2.png";
	building_3.src = "./Images/Sprites/building_new_3.png";
	building_4.src = "./Images/Sprites/building_new_4.png";
	building_bank.src = "./Images/Sprites/building_bank.png";
	background.src = "./Images/Backgrounds/background.png";
}

function resizeWindow(){
	var gameArea = document.getElementById('gamearea');
	var widthToHeight = 2 / 1;
	var newWidth = window.innerWidth;
	var newHeight = window.innerHeight;
	var newWidthToHeight = newWidth / newHeight;
	
	if (newWidthToHeight > widthToHeight) {
		// window width is too wide relative to desired game width
		newWidth = newHeight * widthToHeight;
		gameArea.style.height = newHeight + 'px';
		gameArea.style.width = newWidth + 'px';
	} 
	else { 
		//window height is too high relative to desired game height
		newHeight = newWidth / widthToHeight;
		gameArea.style.width = newWidth + 'px';
		gameArea.style.height = newHeight + 'px';
	}
	gameArea.style.marginTop = (-newHeight / 2) + 'px';
	gameArea.style.marginLeft = (-newWidth / 2) + 'px';
	
    maincanvas.width = newWidth;
    maincanvas.height = newHeight;
	
	screenWidth = newWidth;
	screenHeight = newHeight;
}

function generateWorld(){
	gameBuilding_A = new Building(building_1, 0, 0, 100, 100);
	
	/*
	gameBuilding_B = new Building();
	gameBuilding_B.init(building_2, 0, 0, 100, 100);
	
	gameBuilding_C = new Building();
	gameBuilding_C.init(building_3, 0, 0, 100, 100);
	
	gameBuilding_D = new Building();
	gameBuilding_D.init(building_4, 0, 0, 100, 100);
	
	gameBuilding_bank = new Building();
	gameBuilding_bank.init(building_bank, 0, 0, 100, 100);
	*/
	
	gameBackground = new Background();
	gameBackgroundB = new Background();
	
	gameBackground.init(background, 0, 0, screenWidth, screenHeight);
	gameBackgroundB.init(background, screenWidth, 0, screenWidth, screenHeight);
	
	backgrounds.push(gameBackground);
	backgrounds.push(gameBackgroundB);
	
	/*
	var building1 =	new Building();
	building1.init(building_1, 0, 0, 100, 100);
	building1.setX(20);
	sprites.push(building1);
	
	var building2 = new Building();
	building2.init(building_1, 0, 0, 100, 100);
	building2.setX(100);
	sprites.push(building2);
	*/
	
	var building1 = createBuilding(building_1, 20, 40);
	var building2 = createBuilding(building_1, 80, 40);
	var building3 = createBuilding(building_1, 140, 40);
}

function createBuilding(img, x, y){
	building = new Building();
	building.init(img, x, y, 100, 100);
	sprites.push(building);
	return building;
}

function roundSetup(){
	renderCanvasInterval = setInterval(update, 10);  			// game loop
}

function renderBackground(){
	mctx.clearRect(0, 0, maincanvas.width, maincanvas.height);
	
	for(i = 0; i < backgrounds.length; i++){
		backgrounds[i].draw();
	}
	
	for(i = 0; i < sprites.length; i++){
		sprites[i].draw();
	}
}

function update(){
	renderBackground();
}

/**
*	Touch
**/

function handleTouchstartEvent(e){
	console.log("Touch started");
	
    touchStartX = e.changedTouches[0].pageX;
    touchStartY = e.changedTouches[0].pageY;
	
	screenDown = true;
	//checkTap(touchStartX, touchStartY);
}

function handleTouchmoveEvent(e){
    screenWasSwiped = true;
	console.log("Touch move");
}

function handleTouchendEvent(e){
	console.log("Touch end");

	screenDown = false;
    touchEndX = e.changedTouches[0].pageX;
    touchEndY = e.changedTouches[0].pageY;
	
	console.log("Touch end X: "+touchEndX);
	console.log("Touch end Y: "+touchEndY);
	
    if(screenWasSwiped){
        screenWasSwiped = false;
		if(Math.abs(touchStartX - touchEndX) > Math.abs(touchStartY - touchEndY)){ 	// vertical swipe
		
		}
		else{
			var moveAmount;
			if(touchStartX > touchEndX){ 											// horizontal swipe to right
				moveAmount = touchStartX-touchEndX;
				console.log("Swipe to right");
			}
			else{																	// horizontal swipe to left
				moveAmount = touchEndX-touchStartX;
				moveAmount = moveAmount*-1;
				console.log("Swipe to left");
			}
			horizontalSwipe(moveAmount);
		}
    }
	else{	// tap

	}
}

/**
*	Movement
**/

function horizontalSwipe(moveAmount){
	for(i = 0; i < backgrounds.length; i++){
		var offset = backgrounds.getX();
		console.log("Offset: "+offset);
		backgrounds[i].setX(offset+moveAmount);
	}
}


</script>